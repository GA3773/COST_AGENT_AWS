{% extends "base.html" %}

{% block title %}Cost Agent - EMR Optimization{% endblock %}

{% block body %}
<div class="app-layout">
    <!-- Sidebar: Cluster List -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar__header">
            <h1 class="sidebar__title">COST AGENT</h1>
            <button class="btn btn--icon" id="btnRefresh" title="Refresh">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                </svg>
            </button>
        </div>

        <div class="sidebar__section-title">
            <span>Transient Clusters</span>
            <span class="sidebar__count" id="clusterCount">-</span>
        </div>

        <div class="cluster-list" id="clusterList">
            <div class="cluster-list__loading">Loading...</div>
        </div>

        <div class="sidebar__pagination" id="pagination">
            <button class="btn btn--icon btn--small" id="btnPrev" disabled>&lt;</button>
            <span class="pagination__info" id="paginationInfo">-</span>
            <button class="btn btn--icon btn--small" id="btnNext" disabled>&gt;</button>
        </div>
    </aside>

    <!-- Main Content: Agent Panel -->
    <main class="main-panel" id="mainPanel">
        <!-- Empty state when no cluster selected -->
        <div class="empty-state" id="emptyState">
            <div class="empty-state__icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 6v6l4 2"/>
                </svg>
            </div>
            <h2 class="empty-state__title">Select a Cluster</h2>
            <p class="empty-state__text">Choose a cluster from the list to analyze and optimize its instance configuration.</p>
        </div>

        <!-- Agent Panel (shown when cluster selected) -->
        <div class="agent-view" id="agentView" style="display: none;">
            <div class="agent-view__header">
                <div class="agent-view__title-group">
                    <h2 class="agent-view__title" id="selectedClusterName">-</h2>
                    <span class="agent-view__badge">Optimization</span>
                </div>
                <button class="btn btn--secondary btn--small" id="btnClosePanel">Close</button>
            </div>

            <!-- Subway Graph -->
            <div class="subway-graph" id="subwayGraph">
                <div class="subway-graph__track">
                    <div class="subway-node" data-step="analyze">
                        <div class="subway-node__dot"></div>
                        <div class="subway-node__label">Analyze</div>
                    </div>
                    <div class="subway-connector"></div>
                    <div class="subway-node subway-node--clickable" data-step="recommend" id="recommendNode">
                        <div class="subway-node__dot"></div>
                        <div class="subway-node__label">Recommend</div>
                    </div>
                    <div class="subway-connector"></div>
                    <div class="subway-node" data-step="approval">
                        <div class="subway-node__dot"></div>
                        <div class="subway-node__label" id="approvalLabel">Approval</div>
                    </div>
                    <div class="subway-connector"></div>
                    <div class="subway-node" data-step="modify">
                        <div class="subway-node__dot"></div>
                        <div class="subway-node__label">Modify Config</div>
                    </div>
                    <div class="subway-connector"></div>
                    <div class="subway-node" data-step="create">
                        <div class="subway-node__dot"></div>
                        <div class="subway-node__label">Create Cluster</div>
                    </div>
                    <div class="subway-connector"></div>
                    <div class="subway-node" data-step="monitor">
                        <div class="subway-node__dot"></div>
                        <div class="subway-node__label">Monitor</div>
                    </div>
                    <div class="subway-connector subway-connector--phase2"></div>
                    <div class="subway-node subway-node--phase2" data-step="clone">
                        <div class="subway-node__dot"></div>
                        <div class="subway-node__label">Clone Steps</div>
                    </div>
                    <div class="subway-connector subway-connector--phase2"></div>
                    <div class="subway-node subway-node--phase2" data-step="compare">
                        <div class="subway-node__dot"></div>
                        <div class="subway-node__label">Compare</div>
                    </div>
                    <div class="subway-connector subway-connector--phase2"></div>
                    <div class="subway-node subway-node--phase2" data-step="finalize">
                        <div class="subway-node__dot"></div>
                        <div class="subway-node__label">Finalize</div>
                    </div>
                </div>
            </div>

            <!-- Recommendation Popup -->
            <div class="recommendation-popup" id="recommendPopup" style="display: none;">
                <div class="recommendation-popup__header">
                    <span>Recommendation Summary</span>
                    <button class="btn btn--icon btn--small" id="closeRecommendPopup">&times;</button>
                </div>
                <div class="recommendation-popup__content" id="recommendContent">
                    No recommendation yet.
                </div>
            </div>

            <!-- Chat Area -->
            <div class="chat" id="chat">
                <div class="chat__messages" id="messages"></div>

                <div class="chat__footer">
                    <div class="chat__approval" id="approval" style="display: none;">
                        <button class="btn btn--primary" id="btnApprove">Proceed with Optimization</button>
                        <button class="btn btn--secondary" id="btnCancel">Cancel</button>
                    </div>

                    <div class="chat__progress" id="progress" style="display: none;">
                        <div class="progress__indicator"></div>
                        <span class="progress__text" id="progressText"></span>
                    </div>

                    <div class="chat__input">
                        <input
                            type="text"
                            class="input-field"
                            id="userInput"
                            placeholder="Type 'analyze' or ask a question..."
                            autocomplete="off"
                        >
                        <button class="btn btn--primary" id="btnSend">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<script src="{{ url_for('static', filename='js/agent.js') }}"></script>
{% endblock %}
